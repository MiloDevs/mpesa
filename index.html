<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Interface</title>
</head>
<body>
  <h1>Enter Your Phone Number</h1>
  <form id="paymentForm">
    <label for="phoneNumber">Phone Number:</label>
    <input type="text" id="phoneNumber" name="phoneNumber" required>
    <input type="hidden" id="partyA" name="partyA" value="254728859865">
    <input type="hidden" id="amount" name="amount" value="1">
    <input type="hidden" id="callbackURL" name="callbackURL" value="https://www.payments.house-of-curtains.biz/callback">
    <button type="submit">Pay</button>
  </form>
  <div id="status"></div>

  <script>
    document.getElementById('paymentForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      
      const phoneNumber = document.getElementById('phoneNumber').value;
      const partyA = document.getElementById('partyA').value;
      const amount = document.getElementById('amount').value;
      const callbackURL = document.getElementById('callbackURL').value;

      try {
        const response = await fetch('/api/mpesa/transaction', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phoneNumber, partyA, amount, CallbackURL: callbackURL })
        });

        if (!response.ok) {
          const errorData = await response.json();
          document.getElementById('status').innerText = `Error: ${errorData.error}`;
          return;
        }

        const data = await response.json();
        document.getElementById('status').innerText = 'Transaction initiated. Waiting for confirmation...';

        // Poll for transaction status
        const transactionId = data.CheckoutRequestID;
        pollTransactionStatus(transactionId);
      } catch (error) {
        document.getElementById('status').innerText = `Error: ${error.message}`;
      }
    });

    const pollTransactionStatus = (transactionId) => {
      const interval = setInterval(async () => {
        const response = await fetch(`/api/mpesa/status/${transactionId}`);
        const statusData = await response.json();

        if (statusData.status === 'Completed' || statusData.status === 'Failed') {
          clearInterval(interval);
          document.getElementById('status').innerText = `Transaction ${statusData.status}: ${statusData.message}`;
        }
      }, 5000); // Poll every 5 seconds
    };
  </script>
</body>
</html>
